{% extends 'layout.html' %}

{% block content %}
<!-- Clean Dashboard following Dieter Rams principles -->
<div class="dashboard-container">
    <!-- Large time display -->
    <div class="time-hero text-center mb-5">
        <div class="current-time-large" id="dashboard-time">00:00 PM</div>
        <div class="current-date text-muted" id="dashboard-date">LOADING DATE</div>
    </div>

    <!-- Clean metric cards grid -->
    <div class="metrics-grid">
        <!-- Focus Score -->
        <div class="metric-card-large">
            <div class="metric-header">
                <i data-feather="target" class="metric-icon"></i>
                <span class="metric-title">FOCUS SCORE</span>
            </div>
            <div class="metric-display">
                <div class="metric-number" id="focus-score-display">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-subtitle">
                <span class="metric-label">TODAY</span>
                <span class="metric-comparison" id="focus-comparison">85% AVERAGE</span>
            </div>
        </div>

        <!-- Activity Status -->
        <div class="metric-card-large">
            <div class="metric-header">
                <i data-feather="activity" class="metric-icon"></i>
                <span class="metric-title">ACTIVITY</span>
            </div>
            <div class="activity-status">
                <div class="activity-state" id="activity-state-display">MONITORING</div>
                <div class="activity-timer text-muted" id="activity-timer-display">0m 0s</div>
            </div>
            <div class="activity-progress-container">
                <div class="progress">
                    <div id="activity-progress" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Posture Monitor -->
        <div class="metric-card-large">
            <div class="metric-header">
                <i data-feather="user" class="metric-icon"></i>
                <span class="metric-title">POSTURE</span>
            </div>
            <div class="posture-status">
                <div class="posture-state" id="posture-state-display">CHECKING</div>
                <div class="posture-feedback text-muted" id="posture-feedback-display">Sit upright for optimal focus</div>
            </div>
            <div class="posture-angle-container">
                <div class="angle-display">
                    <span class="angle-value" id="spine-angle-display">0°</span>
                    <span class="angle-label">SPINE</span>
                </div>
                <div class="progress">
                    <div id="angle-indicator" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Camera Feed -->
        <div class="metric-card-large camera-card">
            <div class="metric-header">
                <i data-feather="camera" class="metric-icon"></i>
                <span class="metric-title">MONITOR</span>
            </div>
            <div class="camera-display">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="output-canvas" class="d-none"></canvas>
                <div id="camera-placeholder" class="camera-placeholder">
                    <i data-feather="camera-off" class="camera-placeholder-icon"></i>
                    <p class="camera-placeholder-text">Camera not available</p>
                    <button id="start-camera" class="btn btn-primary">Start Camera</button>
                </div>
            </div>
        </div>

        <!-- Water Intake -->
        <div class="metric-card-large hydration-card">
            <div class="metric-header">
                <i data-feather="droplet" class="metric-icon"></i>
                <span class="metric-title">HYDRATION</span>
            </div>
            <div class="hydration-display">
                <div class="water-amount" id="water-amount-display">0 / 2000 ml</div>
                <div class="water-level-container">
                    <div class="water-bottle-simple">
                        <div id="water-level" class="water-level" style="height: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="water-controls">
                <button class="btn btn-outline-primary water-btn" data-amount="250">250ml</button>
                <button class="btn btn-outline-primary water-btn" data-amount="500">500ml</button>
            </div>
        </div>

        <!-- Health Summary -->
        <div class="metric-card-large health-card">
            <div class="metric-header">
                <i data-feather="heart" class="metric-icon"></i>
                <span class="metric-title">HEALTH SCORE</span>
            </div>
            <div class="health-summary">
                <div class="health-score-display">
                    <div class="health-score-number" id="health-score-value">--</div>
                    <div class="health-score-unit">%</div>
                </div>
                <div class="health-breakdown">
                    <div class="health-metric">
                        <span class="health-metric-label">FOCUS</span>
                        <span class="health-metric-value" id="health-focus-score">--</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">POSTURE</span>
                        <span class="health-metric-value" id="health-posture-score">--</span>
                    </div>
                    <div class="health-metric">
                        <span class="health-metric-label">HYDRATION</span>
                        <span class="health-metric-value" id="health-hydration-score">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard-specific JavaScript for Dieter Rams design
document.addEventListener('DOMContentLoaded', function() {
    // Update time display
    function updateTime() {
        const now = new Date();
        const timeOptions = { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        };
        const dateOptions = { 
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        };
        
        document.getElementById('dashboard-time').textContent = now.toLocaleTimeString('en-US', timeOptions);
        document.getElementById('dashboard-date').textContent = now.toLocaleDateString('en-US', dateOptions).toUpperCase();
    }
    
    // Initial time update and interval
    updateTime();
    setInterval(updateTime, 1000);

    // Map old IDs to new dashboard IDs
    const idMapping = {
        'focus-score': 'focus-score-display',
        'activity-description': 'activity-state-display',
        'activity-timer': 'activity-timer-display',
        'posture-feedback': 'posture-state-display',
        'posture-advice': 'posture-feedback-display',
        'angle-indicator': 'angle-indicator',
        'water-amount': 'water-amount-display',
        'health-score-value': 'health-score-value',
        'health-focus-score': 'health-focus-score',
        'health-posture-score': 'health-posture-score',
        'health-hydration-score': 'health-hydration-score'
    };

    // Update focus score display
    function updateFocusScore(score) {
        const element = document.getElementById('focus-score-display');
        if (element) {
            element.textContent = score !== null ? Math.round(score) : '--';
        }
    }

    // Update activity status
    function updateActivityStatus(data) {
        const stateElement = document.getElementById('activity-state-display');
        const timerElement = document.getElementById('activity-timer-display');
        
        if (stateElement && data.activity_state) {
            stateElement.textContent = data.activity_state.toUpperCase().replace('_', ' ');
        }
        
        if (timerElement && data.time_in_state !== undefined) {
            const minutes = Math.floor(data.time_in_state / 60);
            const seconds = data.time_in_state % 60;
            timerElement.textContent = `${minutes}m ${seconds}s`;
        }
    }

    // Update posture status
    function updatePostureStatus(data) {
        const stateElement = document.getElementById('posture-state-display');
        const feedbackElement = document.getElementById('posture-feedback-display');
        const angleElement = document.getElementById('spine-angle-display');
        
        if (stateElement && data.posture) {
            stateElement.textContent = data.posture.toUpperCase().replace('_', ' ');
        }
        
        if (feedbackElement && data.feedback) {
            feedbackElement.textContent = data.feedback;
        }
        
        if (angleElement && data.angle !== undefined) {
            angleElement.textContent = Math.round(data.angle) + '°';
        }
    }

    // Update water amount
    function updateWaterAmount(amount, target = 2000) {
        const element = document.getElementById('water-amount-display');
        if (element) {
            element.textContent = `${amount} / ${target} ml`;
        }
        
        // Update water level
        const levelElement = document.getElementById('water-level');
        if (levelElement) {
            const percentage = Math.min((amount / target) * 100, 100);
            levelElement.style.height = percentage + '%';
        }
    }

    // Add water intake button handlers
    document.querySelectorAll('.water-btn').forEach(button => {
        button.addEventListener('click', function() {
            const amount = parseInt(this.dataset.amount);
            fetch('/api/water', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ amount: amount })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateWaterAmount(data.total_intake);
                }
            })
            .catch(error => console.error('Error adding water:', error));
        });
    });

    // Start camera functionality
    const startCameraBtn = document.getElementById('start-camera');
    if (startCameraBtn) {
        startCameraBtn.addEventListener('click', function() {
            // This will integrate with existing camera logic
            if (window.startCamera) {
                window.startCamera();
            }
        });
    }

    // Existing monitoring functions integration
    if (window.startMonitoring) {
        window.startMonitoring();
    }
});
</script>

<!-- Notification Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i data-feather="bell" class="feather-icon-sm me-2"></i>
            <strong class="me-auto" id="toast-title">Notification</strong>
            <small id="toast-time">now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Hello, world! This is a notification message.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load application scripts -->
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
<script src="{{ url_for('static', filename='js/posture.js') }}"></script>
<script src="{{ url_for('static', filename='js/water_intake.js') }}"></script>
<script src="{{ url_for('static', filename='js/activity_monitor.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
