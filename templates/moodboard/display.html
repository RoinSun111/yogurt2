{% extends "layout.html" %}

{% block styles %}
<style>
.moodboard-container {
    width: 100%;
    max-width: 375px;
    min-height: 100vh;
    margin: 0 auto;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 0;
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
}

@media (min-width: 768px) {
    .moodboard-container {
        border-radius: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 2px solid #333;
        min-height: 812px;
        height: 812px;
        padding: 20px;
    }
}

.moodboard-header {
    text-align: center;
    margin-bottom: 20px;
}

.current-time {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
}

.current-date {
    font-size: 0.9rem;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.widget {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 15px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
}

.widget:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.widget-title {
    font-size: 0.85rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.widget-title i {
    margin-right: 10px;
    color: rgba(255, 255, 255, 0.8);
    width: 18px;
    height: 18px;
}

.mood-widget {
    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
    color: white;
    text-align: center;
    border: none;
    position: relative;
    overflow: hidden;
}

.mood-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.mood-text {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.4;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.mood-content {
    position: relative;
}

.mood-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin: 0;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: background 0.2s;
    word-wrap: break-word;
    line-height: 1.4;
}

.mood-text:hover {
    background: rgba(255, 255, 255, 0.1);
}

.mood-edit-container {
    width: 100%;
}

.mood-input {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 12px;
    width: 100%;
    font-size: 1rem;
    resize: none;
    min-height: 60px;
    font-family: inherit;
}

.mood-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.mood-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.3);
}

.mood-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.char-count {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
}

.mood-buttons {
    display: flex;
    gap: 8px;
}

.mood-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.mood-btn.save {
    background: rgba(255, 255, 255, 0.3);
}

.mood-btn:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: translateY(-1px);
}

.calendar-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.calendar-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.calendar-widget.expanded {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90vw;
    max-width: 400px;
    height: auto;
    max-height: 90vh;
    z-index: 1000;
    overflow-y: auto;
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.calendar-widget {
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Today View Styling */
.today-view {
    color: white;
}

.today-date {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
}

.today-number {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 18px;
    font-size: 1.8rem;
    font-weight: 800;
    border: 2px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.today-info {
    flex: 1;
}

.today-month {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 2px;
    color: white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.today-year {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

.today-meetings {
    margin-bottom: 15px;
}

.meetings-header {
    font-size: 0.85rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.meetings-list {
    max-height: 120px;
    overflow-y: auto;
}

.meeting-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    gap: 12px;
    border-radius: 10px;
    margin-bottom: 6px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
}

.meeting-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.meeting-item.clickable {
    cursor: pointer;
    background: rgba(255, 255, 255, 0.08);
}

.meeting-item.clickable:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.meeting-location {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 2px;
}

.meeting-time {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    min-width: 45px;
    text-align: center;
}

.meeting-title {
    flex: 1;
    font-size: 0.9rem;
}

.expand-calendar-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 8px 12px;
    font-size: 0.8rem;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.expand-calendar-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Full Calendar View Styling */
.full-calendar-view {
    color: white;
}

.calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.btn-calendar-nav {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    color: white;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-calendar-nav:hover {
    background: rgba(255, 255, 255, 0.3);
}

.calendar-month-year {
    font-size: 1.1rem;
    font-weight: 600;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 8px;
}

.weekday {
    text-align: center;
    padding: 8px 4px;
    font-size: 0.75rem;
    font-weight: 600;
    opacity: 0.8;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 15px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 0.8rem;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.calendar-day:hover {
    background: rgba(255, 255, 255, 0.2);
}

.calendar-day.today {
    background: #ff6b35;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
}

.calendar-day.other-month {
    opacity: 0.4;
}

.collapse-calendar-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 8px 12px;
    font-size: 0.8rem;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.collapse-calendar-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Event Modal Styling */
.event-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-modal-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    color: white;
    position: relative;
}

.event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.event-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.2);
}

.event-field {
    margin-bottom: 15px;
}

.event-field label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9rem;
    font-weight: 600;
}

.event-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 0.9rem;
    box-sizing: border-box;
}

.event-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.event-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.3);
}

.event-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.event-modal-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-save {
    background: #ff6b35;
    color: white;
}

.btn-save:hover {
    background: #ff5722;
}

.btn-delete {
    background: #f44336;
    color: white;
}

.btn-delete:hover {
    background: #d32f2f;
}

.btn-cancel {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

.btn-cancel:hover {
    background: rgba(255, 255, 255, 0.3);
}

.todo-widget {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
}

.todo-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.focus-widget {
    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
    border: none;
}

.focus-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.water-widget {
    background: linear-gradient(135deg, #13c2c2 0%, #52c41a 100%);
    border: none;
}

.water-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.posture-widget {
    background: linear-gradient(135deg, #fa8c16 0%, #faad14 100%);
    border: none;
}

.posture-widget::before {
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
}

.todo-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    transition: all 0.2s ease;
}

.todo-item:last-child {
    border-bottom: none;
}

.todo-item:hover {
    background: rgba(255, 255, 255, 0.05);
    margin: 0 -15px;
    padding: 12px 15px;
    border-radius: 8px;
}

.todo-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.8);
    margin-right: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: transparent;
}

.todo-checkbox:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: white;
    transform: scale(1.1);
}

.todo-text {
    flex: 1;
    color: white;
    font-size: 0.95rem;
    font-weight: 500;
    line-height: 1.3;
}

.todo-priority {
    font-size: 0.7rem;
    padding: 4px 8px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.25);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stat-card {
    text-align: center;
    padding: 16px 12px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.stat-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: white;
    margin-bottom: 4px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.stat-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.add-todo-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    color: white;
    padding: 10px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    backdrop-filter: blur(10px);
}

.add-todo-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
}

.add-todo-btn i {
    width: 16px;
    height: 16px;
}

.customize-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 18px;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    color: rgba(255, 255, 255, 0.9);
}

.customize-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.3) 0%, rgba(247, 147, 30, 0.3) 100%);
    border-radius: 18px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.customize-btn:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 107, 53, 0.4);
    box-shadow: 0 12px 40px rgba(255, 107, 53, 0.25);
    color: white;
}

.customize-btn:hover::before {
    opacity: 1;
}

.customize-btn i {
    width: 20px;
    height: 20px;
    z-index: 1;
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="moodboard-container">
    <!-- Header with Time -->
    <div class="moodboard-header">
        <div class="current-time" id="moodboard-time">12:00</div>
        <div class="current-date" id="moodboard-date">Today</div>
    </div>

    <!-- Dynamic Widgets based on saved configuration -->
    <div class="widgets-grid">
        {% for widget in widgets | sort(attribute='position_y') | sort(attribute='position_x') %}
            {% if widget.widget_type == 'mood' %}
                <!-- Mood Widget -->
                <div class="widget mood-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="smile"></i>
                        Mood
                    </div>
                    <div class="mood-content">
                        {% if current_mood %}
                            <p class="mood-text" id="mood-display" onclick="editMood()">{{ current_mood.mood_text }}</p>
                            <div class="mood-edit-container" id="mood-edit-container" style="display: none;">
                                <textarea class="mood-input" placeholder="How are you feeling today?" id="mood-input" maxlength="140">{{ current_mood.mood_text }}</textarea>
                                <div class="mood-actions">
                                    <span class="char-count" id="char-count">{{ current_mood.mood_text|length }}/140</span>
                                    <div class="mood-buttons">
                                        <button class="mood-btn save" onclick="saveMood()">Save</button>
                                        <button class="mood-btn cancel" onclick="cancelMoodEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="mood-edit-container" id="mood-edit-container">
                                <textarea class="mood-input" placeholder="How are you feeling today?" id="mood-input" maxlength="140"></textarea>
                                <div class="mood-actions">
                                    <span class="char-count" id="char-count">0/140</span>
                                    <div class="mood-buttons">
                                        <button class="mood-btn save" onclick="saveMood()">Save</button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            
            {% elif widget.widget_type == 'calendar' %}
                <!-- Calendar Widget -->
                <div class="widget calendar-widget" id="calendar-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="calendar"></i>
                        Calendar
                    </div>
                    
                    <!-- Today's Info (Default View) -->
                    <div class="today-view" id="today-view">
                        <div class="today-date">
                            <div class="today-number" id="today-number">15</div>
                            <div class="today-info">
                                <div class="today-month" id="today-month">June</div>
                                <div class="today-year" id="today-year">2025</div>
                            </div>
                        </div>
                        
                        <div class="today-meetings">
                            <div class="meetings-header">Today's Meetings</div>
                            <div class="meetings-list" id="meetings-list">
                                <!-- Calendar events will be loaded dynamically -->
                                <div class="meeting-item" style="display: none;">
                                    <div class="meeting-time">Loading...</div>
                                    <div class="meeting-title">Loading meetings...</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="expand-calendar-btn" onclick="expandCalendar()">
                            <i data-feather="maximize-2"></i>
                            View Full Calendar
                        </button>
                    </div>
                    
                    <!-- Full Calendar View (Hidden by default) -->
                    <div class="full-calendar-view" id="full-calendar-view" style="display: none;">
                        <div class="calendar-header">
                            <button class="btn-calendar-nav" onclick="previousMonth()">
                                <i data-feather="chevron-left"></i>
                            </button>
                            <div class="calendar-month-year" id="calendar-month-year">June 2025</div>
                            <button class="btn-calendar-nav" onclick="nextMonth()">
                                <i data-feather="chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                        </div>
                        
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                        
                        <button class="collapse-calendar-btn" onclick="collapseCalendar()">
                            <i data-feather="minimize-2"></i>
                            Back to Today
                        </button>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'todo' %}
                <!-- Todo Widget -->
                <div class="widget todo-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="check-square"></i>
                        Todo
                    </div>
                    <div id="todo-list">
                        {% for todo in todos %}
                        <div class="todo-item" data-todo-id="{{ todo.id }}">
                            <div class="todo-checkbox" onclick="completeTodo({{ todo.id }})"></div>
                            <div class="todo-text">{{ todo.title }}</div>
                            <div class="todo-priority">{{ todo.priority }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="add-todo-btn" onclick="showAddTodoModal()">
                        <i data-feather="plus"></i>
                        Add Todo
                    </button>
                </div>
            
            {% elif widget.widget_type == 'focus_score' %}
                <!-- Focus Score Widget -->
                <div class="widget focus-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="target"></i>
                        Focus Score
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ focus_score }}%</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">85%</div>
                            <div class="stat-label">Average</div>
                        </div>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'water' %}
                <!-- Water Intake Widget -->
                <div class="widget water-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="droplet"></i>
                        Water Intake
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ (total_water/1000)|round(1) }}L</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">8</div>
                            <div class="stat-label">Goal</div>
                        </div>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'posture_score' %}
                <!-- Posture Score Widget -->
                <div class="widget posture-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="user"></i>
                        Posture
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">
                                {% if latest_posture %}
                                    {{ latest_posture.posture_quality|title }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <div class="stat-label">Current</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                {% if latest_posture %}
                                    {{ latest_posture.angle|round(0) }}°
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <div class="stat-label">Angle</div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Modals and Global Components (outside of widget loop) -->
    <!-- Event Details Modal -->
    <div class="event-modal" id="event-modal" style="display: none;">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h3 id="event-title">Meeting Details</h3>
                <button class="close-modal" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="event-modal-body">
                <div class="event-field">
                    <label>Title:</label>
                    <input type="text" id="edit-event-title" class="event-input">
                </div>
                <div class="event-field">
                    <label>Time:</label>
                    <input type="time" id="edit-event-time" class="event-input">
                </div>
                <div class="event-field">
                    <label>Location:</label>
                    <input type="text" id="edit-event-location" class="event-input">
                </div>
                <div class="event-field">
                    <label>Description:</label>
                    <textarea id="edit-event-description" class="event-input" rows="3"></textarea>
                </div>
            </div>
            <div class="event-modal-actions">
                <button class="btn-save" onclick="saveEventChanges()">Save Changes</button>
                <button class="btn-delete" onclick="deleteEvent()">Delete Event</button>
                <button class="btn-cancel" onclick="closeEventModal()">Cancel</button>
            </div>
        </div>
    </div>



<!-- Customize Button -->
<button class="customize-btn" onclick="window.location.href='/moodboard/customize'">
    <i data-feather="settings"></i>
</button>

<!-- Add Todo Modal -->
<div class="modal fade" id="addTodoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Todo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="todoTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="todoTitle" placeholder="Enter todo title">
                </div>
                <div class="mb-3">
                    <label for="todoDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="todoDescription" rows="3" placeholder="Optional description"></textarea>
                </div>
                <div class="mb-3">
                    <label for="todoPriority" class="form-label">Priority</label>
                    <select class="form-select" id="todoPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="todoDueDate" class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="todoDueDate">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTodo()">Add Todo</button>
            </div>
        </div>
    </div>
</div>

<script>
// Update time and date
function updateDateTime() {
    const now = new Date();
    const timeEl = document.getElementById('moodboard-time');
    const dateEl = document.getElementById('moodboard-date');
    
    timeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    dateEl.textContent = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Calendar state
let currentCalendarDate = new Date();

// Update today's info and load calendar events
function updateTodayInfo() {
    const today = new Date();
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('today-number').textContent = today.getDate();
    document.getElementById('today-month').textContent = months[today.getMonth()];
    document.getElementById('today-year').textContent = today.getFullYear();
    
    // Load today's calendar events
    loadTodayCalendarEvents();
}

// Load today's calendar events from the API
function loadTodayCalendarEvents() {
    const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
    
    fetch(`/api/moodboard/calendar/events?date=${today}`)
        .then(response => response.json())
        .then(data => {
            const meetingsList = document.getElementById('meetings-list');
            
            if (data.success && data.events.length > 0) {
                meetingsList.innerHTML = '';
                
                data.events.forEach(event => {
                    const meetingItem = document.createElement('div');
                    meetingItem.className = 'meeting-item clickable';
                    meetingItem.setAttribute('data-event-id', event.id);
                    meetingItem.onclick = () => showEventDetails(event);
                    
                    const timeElement = document.createElement('div');
                    timeElement.className = 'meeting-time';
                    timeElement.textContent = event.time;
                    
                    const titleElement = document.createElement('div');
                    titleElement.className = 'meeting-title';
                    titleElement.textContent = event.title;
                    
                    if (event.location) {
                        const locationElement = document.createElement('div');
                        locationElement.className = 'meeting-location';
                        locationElement.textContent = event.location;
                        titleElement.appendChild(locationElement);
                    }
                    
                    meetingItem.appendChild(timeElement);
                    meetingItem.appendChild(titleElement);
                    meetingsList.appendChild(meetingItem);
                });
            } else {
                meetingsList.innerHTML = '<div class="meeting-item"><div class="meeting-time"></div><div class="meeting-title">No meetings scheduled</div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading calendar events:', error);
            const meetingsList = document.getElementById('meetings-list');
            meetingsList.innerHTML = '<div class="meeting-item"><div class="meeting-time"></div><div class="meeting-title">Error loading events</div></div>';
        });
}

// Generate calendar for full view
function generateCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const today = new Date();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    
    // Update month/year display
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendar-month-year').textContent = `${months[month]} ${year}`;
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = date.getDate();
        
        if (date.getMonth() !== month) {
            dayEl.classList.add('other-month');
        }
        
        if (date.toDateString() === today.toDateString()) {
            dayEl.classList.add('today');
        }
        
        calendarGrid.appendChild(dayEl);
    }
}

// Calendar navigation
function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    generateCalendar();
}

// Expand/collapse calendar
function expandCalendar() {
    const calendarWidget = document.getElementById('calendar-widget');
    const backdrop = document.createElement('div');
    backdrop.className = 'calendar-backdrop';
    backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0);
        z-index: 999;
        backdrop-filter: blur(0px);
        transition: all 0.15s ease-out;
    `;
    backdrop.onclick = collapseCalendar;
    
    document.body.appendChild(backdrop);
    
    // Trigger animations
    requestAnimationFrame(() => {
        backdrop.style.background = 'rgba(0, 0, 0, 0.7)';
        backdrop.style.backdropFilter = 'blur(5px)';
        calendarWidget.classList.add('expanded');
        document.getElementById('today-view').style.display = 'none';
        document.getElementById('full-calendar-view').style.display = 'block';
    });
    
    generateCalendar();
    feather.replace();
}

function collapseCalendar() {
    const calendarWidget = document.getElementById('calendar-widget');
    const backdrop = document.querySelector('.calendar-backdrop');
    
    if (backdrop) {
        backdrop.style.background = 'rgba(0, 0, 0, 0)';
        backdrop.style.backdropFilter = 'blur(0px)';
        
        setTimeout(() => {
            backdrop.remove();
        }, 150);
    }
    
    calendarWidget.classList.remove('expanded');
    
    // Use a slight delay to ensure smooth animation
    setTimeout(() => {
        document.getElementById('today-view').style.display = 'block';
        document.getElementById('full-calendar-view').style.display = 'none';
        feather.replace();
    }, 100);
}

// Event management functions
let currentEvent = null;

function showEventDetails(event) {
    currentEvent = event;
    
    // Populate modal with event details
    document.getElementById('event-title').textContent = event.title;
    document.getElementById('edit-event-title').value = event.title;
    document.getElementById('edit-event-time').value = event.time !== 'All Day' ? event.time : '';
    document.getElementById('edit-event-location').value = event.location || '';
    document.getElementById('edit-event-description').value = event.description || '';
    
    // Show modal
    document.getElementById('event-modal').style.display = 'flex';
}

function closeEventModal() {
    document.getElementById('event-modal').style.display = 'none';
    currentEvent = null;
}

function saveEventChanges() {
    if (!currentEvent) return;
    
    const updatedEvent = {
        id: currentEvent.id,
        title: document.getElementById('edit-event-title').value.trim(),
        time: document.getElementById('edit-event-time').value,
        location: document.getElementById('edit-event-location').value.trim(),
        description: document.getElementById('edit-event-description').value.trim()
    };
    
    if (!updatedEvent.title) {
        alert('Event title is required');
        return;
    }
    
    // Send update to server
    fetch(`/api/moodboard/calendar/events/${currentEvent.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updatedEvent)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEventModal();
            loadTodayCalendarEvents(); // Refresh calendar events
        } else {
            alert('Error updating event: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating event:', error);
        alert('Error updating event');
    });
}

function deleteEvent() {
    if (!currentEvent) return;
    
    if (!confirm(`Are you sure you want to delete "${currentEvent.title}"?`)) {
        return;
    }
    
    // Send delete request to server
    fetch(`/api/moodboard/calendar/events/${currentEvent.id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEventModal();
            loadTodayCalendarEvents(); // Refresh calendar events
        } else {
            alert('Error deleting event: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting event:', error);
        alert('Error deleting event');
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('event-modal');
    if (event.target === modal) {
        closeEventModal();
    }
});

// Update mood
function updateMood() {
    const moodInput = document.getElementById('mood-input');
    if (moodInput && moodInput.value.trim()) {
        fetch('/api/moodboard/mood', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mood_text: moodInput.value.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

// Load todos from API
function loadTodos() {
    const today = new Date().toISOString().split('T')[0];
    
    fetch(`/api/moodboard/todos?date=${today}`)
        .then(response => response.json())
        .then(data => {
            const todoList = document.querySelector('.todo-list');
            
            if (data.success && data.todos.length > 0) {
                todoList.innerHTML = '';
                
                data.todos.forEach(todo => {
                    const todoItem = document.createElement('div');
                    todoItem.className = `todo-item ${todo.is_completed ? 'completed' : ''}`;
                    todoItem.setAttribute('data-todo-id', todo.id);
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = todo.is_completed;
                    checkbox.onchange = () => completeTodo(todo.id);
                    
                    const content = document.createElement('div');
                    content.className = 'todo-content';
                    
                    const title = document.createElement('div');
                    title.className = 'todo-title';
                    title.textContent = todo.title;
                    
                    const meta = document.createElement('div');
                    meta.className = 'todo-meta';
                    
                    if (todo.due_time) {
                        meta.textContent = `Due: ${todo.due_time}`;
                        if (todo.has_calendar_event) {
                            meta.textContent += ' 📅';
                        }
                    } else if (todo.priority !== 'medium') {
                        meta.textContent = `Priority: ${todo.priority}`;
                    }
                    
                    content.appendChild(title);
                    if (meta.textContent) {
                        content.appendChild(meta);
                    }
                    
                    todoItem.appendChild(checkbox);
                    todoItem.appendChild(content);
                    todoList.appendChild(todoItem);
                });
            } else {
                todoList.innerHTML = '<div class="todo-item"><div class="todo-content"><div class="todo-title">No todos for today</div></div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading todos:', error);
            const todoList = document.querySelector('.todo-list');
            if (todoList) {
                todoList.innerHTML = '<div class="todo-item"><div class="todo-content"><div class="todo-title">Error loading todos</div></div></div>';
            }
        });
}

// Complete todo
function completeTodo(todoId) {
    fetch(`/api/moodboard/todo/${todoId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const todoItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            if (todoItem) {
                todoItem.style.opacity = '0.5';
                setTimeout(() => {
                    todoItem.remove();
                }, 300);
            }
        }
    });
}

// Show add todo modal
function showAddTodoModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTodoModal'));
    modal.show();
}

// Add todo
function addTodo() {
    const title = document.getElementById('todoTitle').value.trim();
    const description = document.getElementById('todoDescription').value.trim();
    const priority = document.getElementById('todoPriority').value;
    const dueDate = document.getElementById('todoDueDate').value;
    
    if (!title) {
        alert('Please enter a title for the todo');
        return;
    }
    
    fetch('/api/moodboard/todo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            priority: priority,
            due_date: dueDate || null,
            create_calendar_event: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Mood editing functions
function editMood() {
    document.getElementById('mood-display').style.display = 'none';
    document.getElementById('mood-edit-container').style.display = 'block';
    
    const moodInput = document.getElementById('mood-input');
    moodInput.focus();
    
    // Set cursor to end of text
    moodInput.setSelectionRange(moodInput.value.length, moodInput.value.length);
    
    // Setup character counter
    updateCharCount();
}

function cancelMoodEdit() {
    document.getElementById('mood-display').style.display = 'block';
    document.getElementById('mood-edit-container').style.display = 'none';
}

function saveMood() {
    const moodInput = document.getElementById('mood-input');
    const moodText = moodInput.value.trim();
    
    if (!moodText) {
        alert('Please enter your mood');
        return;
    }
    
    if (moodText.length > 140) {
        alert('Mood text must be 140 characters or less');
        return;
    }
    
    fetch('/api/moodboard/mood', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mood_text: moodText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the display text
            const moodDisplay = document.getElementById('mood-display');
            if (moodDisplay) {
                moodDisplay.textContent = moodText;
                cancelMoodEdit();
            } else {
                // If no display element exists (first time), reload to show the new structure
                location.reload();
            }
        } else {
            alert('Failed to save mood: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving mood:', error);
        alert('Failed to save mood. Please try again.');
    });
}

function updateCharCount() {
    const moodInput = document.getElementById('mood-input');
    const charCount = document.getElementById('char-count');
    
    if (moodInput && charCount) {
        const currentLength = moodInput.value.length;
        charCount.textContent = `${currentLength}/140`;
        
        // Change color if approaching limit
        if (currentLength > 120) {
            charCount.style.color = '#ffcccb';
        } else {
            charCount.style.color = 'rgba(255, 255, 255, 0.7)';
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateDateTime();
    setInterval(updateDateTime, 60000); // Update every minute
    updateTodayInfo(); // This also loads calendar events
    loadTodos(); // Load today's todos
    
    // Setup mood input character counter
    const moodInput = document.getElementById('mood-input');
    if (moodInput) {
        moodInput.addEventListener('input', updateCharCount);
        moodInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveMood();
            }
        });
        updateCharCount(); // Initialize counter
    }
    
    // Initialize Feather icons
    feather.replace();
});
</script>
{% endblock %}