{% extends "layout.html" %}

{% block styles %}
<style>
/* Dieter Rams inspired design: clean, functional, minimal */
.moodboard-container {
    width: 100%;
    max-width: 375px;
    min-height: 100vh;
    margin: 0 auto;
    background: #f8f8f8;
    border-radius: 0;
    padding: 24px 16px;
    overflow-y: auto;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
}

@media (min-width: 768px) {
    .moodboard-container {
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid #e8e8e8;
        min-height: 812px;
        height: 812px;
        padding: 32px 24px;
        background: #ffffff;
    }
}

.moodboard-header {
    text-align: left;
    margin-bottom: 32px;
    border-bottom: 1px solid #e8e8e8;
    padding-bottom: 24px;
}

.current-time {
    font-size: 3rem;
    font-weight: 300;
    color: #1a1a1a;
    margin-bottom: 4px;
    letter-spacing: -0.02em;
}

.current-date {
    font-size: 0.9rem;
    color: #666666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

.widget {
    background: #ffffff;
    border-radius: 4px;
    padding: 24px;
    margin-bottom: 16px;
    border: 1px solid #e8e8e8;
    box-shadow: none;
    transition: box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
}

.widget::before {
    display: none;
}

.widget:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.widget-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #666666;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

.widget-title i {
    margin-right: 8px;
    color: #999999;
    width: 14px;
    height: 14px;
}

.mood-widget {
    background: #ffffff;
    color: #1a1a1a;
    text-align: left;
    border: 1px solid #e8e8e8;
    position: relative;
    overflow: hidden;
}

.mood-widget::before {
    display: none;
}

.mood-text {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.4;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.mood-content {
    position: relative;
}

.mood-text {
    font-size: 1.1rem;
    font-weight: 400;
    margin: 0;
    cursor: pointer;
    padding: 12px 16px;
    border-radius: 4px;
    transition: background 0.2s;
    word-wrap: break-word;
    line-height: 1.5;
    color: #1a1a1a;
    background: #f8f8f8;
    border: 1px solid #e8e8e8;
}

.mood-text:hover {
    background: #f0f0f0;
}

.mood-edit-container {
    width: 100%;
}

.mood-input {
    background: #ffffff;
    border: 1px solid #d0d0d0;
    border-radius: 4px;
    color: #1a1a1a;
    padding: 16px;
    width: 100%;
    font-size: 1rem;
    resize: none;
    min-height: 80px;
    font-family: inherit;
    box-sizing: border-box;
}

.mood-input::placeholder {
    color: #999999;
}

.mood-input:focus {
    outline: none;
    border-color: #666666;
    background: #ffffff;
}

.mood-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.char-count {
    font-size: 0.8rem;
    color: var(--flow-warm-600);
}

.mood-buttons {
    display: flex;
    gap: 8px;
}

.mood-btn {
    background: #f8f8f8;
    border: 1px solid #d0d0d0;
    color: #1a1a1a;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background 0.2s;
    font-weight: 500;
}

.mood-btn.save {
    background: #1a1a1a;
    color: #ffffff;
    border-color: #1a1a1a;
}

.mood-btn:hover {
    background: #e8e8e8;
}

.mood-btn.save:hover {
    background: #333333;
}

.calendar-widget {
    background: #ffffff;
    border: 1px solid #e8e8e8;
}

.calendar-widget::before {
    display: none;
}

.calendar-widget.expanded {
    height: auto;
    max-height: none;
}

/* Today View Styling */
.today-view {
    color: var(--flow-warm-800);
}

.today-date {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
}

.today-number {
    background: #f8f8f8;
    color: #1a1a1a;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 1.8rem;
    font-weight: 300;
    border: 1px solid #e8e8e8;
}

.today-info {
    flex: 1;
}

.today-month {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 2px;
    color: #1a1a1a;
}

.today-year {
    font-size: 0.9rem;
    color: #666666;
    font-weight: 400;
}

.today-meetings {
    margin-bottom: 15px;
}

.meetings-header {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #1a1a1a;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

.meetings-list {
    max-height: 120px;
    overflow-y: auto;
}

.meeting-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    gap: 12px;
    border-radius: 4px;
    margin-bottom: 8px;
    transition: background 0.2s ease;
    background: #f8f8f8;
}

.meeting-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.meeting-item.clickable {
    cursor: pointer;
    background: #f8f8f8;
}

.meeting-item.clickable:hover {
    background: #f0f0f0;
}

.meeting-location {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 2px;
}

.meeting-time {
    background: #e8e8e8;
    color: #1a1a1a;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    min-width: 45px;
    text-align: center;
}

.meeting-title {
    flex: 1;
    font-size: 0.9rem;
}

.expand-calendar-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    color: var(--flow-warm-800);
    padding: 8px 12px;
    font-size: 0.8rem;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.expand-calendar-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Full Calendar View Styling */
.full-calendar-view {
    color: var(--flow-warm-800);
}

.calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.btn-calendar-nav {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    color: var(--flow-warm-800);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-calendar-nav:hover {
    background: rgba(255, 255, 255, 0.3);
}

.calendar-month-year {
    font-size: 1.1rem;
    font-weight: 600;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 8px;
}

.weekday {
    text-align: center;
    padding: 8px 4px;
    font-size: 0.75rem;
    font-weight: 600;
    opacity: 0.8;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 15px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 0.8rem;
    color: var(--flow-warm-800);
    cursor: pointer;
    transition: all 0.2s;
}

.calendar-day:hover {
    background: rgba(139, 105, 20, 0.2);
}

.calendar-day.today {
    background: #ff6b35;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.4);
}

.calendar-day.other-month {
    opacity: 0.4;
}

.collapse-calendar-btn {
    background: rgba(139, 105, 20, 0.2);
    border: none;
    border-radius: 10px;
    color: var(--flow-warm-800);
    padding: 8px 12px;
    font-size: 0.8rem;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.collapse-calendar-btn:hover {
    background: rgba(139, 105, 20, 0.3);
}

/* Event Modal Styling */
.event-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-modal-content {
    background: #f5f5dc;
    border-radius: 15px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    color: var(--flow-warm-800);
    position: relative;
    border: 2px solid var(--flow-warm-200);
}

.event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(139, 105, 20, 0.2);
}

.event-modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.close-modal {
    background: none;
    border: none;
    color: var(--flow-warm-800);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.close-modal:hover {
    background: rgba(139, 105, 20, 0.2);
}

.event-field {
    margin-bottom: 15px;
}

.event-field label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9rem;
    font-weight: 600;
}

.event-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--flow-warm-300);
    border-radius: 8px;
    background: var(--flow-warm-100);
    color: var(--flow-warm-800);
    font-size: 0.9rem;
    box-sizing: border-box;
}

.event-input::placeholder {
    color: var(--flow-warm-600);
}

.event-input:focus {
    outline: none;
    background: rgba(139, 105, 20, 0.3);
}

.event-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid rgba(139, 105, 20, 0.2);
}

.event-modal-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-save {
    background: #ff6b35;
    color: var(--flow-warm-800);
}

.btn-save:hover {
    background: #ff5722;
}

.btn-delete {
    background: #f44336;
    color: var(--flow-warm-800);
}

.btn-delete:hover {
    background: #d32f2f;
}

.btn-cancel {
    background: var(--flow-warm-200);
    color: var(--flow-warm-800);
}

.btn-cancel:hover {
    background: rgba(139, 105, 20, 0.3);
}

.todo-widget {
    background: #ffffff;
    border: 1px solid #e8e8e8;
}

.todo-widget::before {
    display: none;
}

.focus-widget {
    background: #ffffff;
    border: 1px solid #e8e8e8;
}

.focus-widget::before {
    display: none;
}

.water-widget {
    background: #ffffff;
    border: 1px solid #e8e8e8;
}

.water-widget::before {
    display: none;
}

.posture-widget {
    background: #ffffff;
    border: 1px solid #e8e8e8;
}

.posture-widget::before {
    display: none;
}

.todo-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    transition: all 0.2s ease;
}

.todo-item:last-child {
    border-bottom: none;
}

.todo-item:hover {
    background: rgba(255, 255, 255, 0.05);
    margin: 0 -15px;
    padding: 12px 15px;
    border-radius: 8px;
}

.todo-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid #d0d0d0;
    margin-right: 12px;
    cursor: pointer;
    transition: border-color 0.2s ease;
    position: relative;
    background: transparent;
}

.todo-checkbox:hover {
    border-color: #1a1a1a;
}

.todo-text {
    flex: 1;
    color: #1a1a1a;
    font-size: 0.95rem;
    font-weight: 400;
    line-height: 1.4;
}

.todo-priority {
    font-size: 0.7rem;
    padding: 4px 8px;
    border-radius: 12px;
    background: var(--flow-warm-200);
    color: var(--flow-warm-800);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.stat-card {
    text-align: left;
    padding: 20px 16px;
    background: #f8f8f8;
    border-radius: 4px;
    border: 1px solid #e8e8e8;
    transition: background 0.2s ease;
}

.stat-card:hover {
    background: #f0f0f0;
}

.stat-value {
    font-size: 2.25rem;
    font-weight: 300;
    color: #1a1a1a;
    margin-bottom: 4px;
    letter-spacing: -0.01em;
}

.stat-label {
    font-size: 0.7rem;
    color: #666666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.add-todo-btn {
    background: var(--flow-warm-200);
    border: 1px solid var(--flow-warm-300);
    border-radius: 12px;
    color: var(--flow-warm-800);
    padding: 10px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    backdrop-filter: blur(10px);
}

.add-todo-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
}

.add-todo-btn i {
    width: 16px;
    height: 16px;
}

.customize-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #1a1a1a;
    border: none;
    border-radius: 4px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    color: #ffffff;
}

.customize-btn::before {
    display: none;
}

.customize-btn:hover {
    background: #333333;
}

.customize-btn i {
    width: 18px;
    height: 18px;
}
</style>
{% endblock %}

{% block content %}
<div class="moodboard-container">
    <!-- Header with Time -->
    <div class="moodboard-header">
        <div class="current-time" id="moodboard-time">12:00</div>
        <div class="current-date" id="moodboard-date">Today</div>
    </div>

    <!-- Dynamic Widgets based on saved configuration -->
    <div class="widgets-grid">
        {% for widget in widgets | sort(attribute='position_y') | sort(attribute='position_x') %}
            {% if widget.widget_type == 'mood' %}
                <!-- Mood Widget -->
                <div class="widget mood-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="smile"></i>
                        Mood
                    </div>
                    <div class="mood-content">
                        {% if current_mood %}
                            <p class="mood-text" id="mood-display" onclick="editMood()">{{ current_mood.mood_text }}</p>
                            <div class="mood-edit-container" id="mood-edit-container" style="display: none;">
                                <textarea class="mood-input" placeholder="How are you feeling today?" id="mood-input" maxlength="140">{{ current_mood.mood_text }}</textarea>
                                <div class="mood-actions">
                                    <span class="char-count" id="char-count">{{ current_mood.mood_text|length }}/140</span>
                                    <div class="mood-buttons">
                                        <button class="mood-btn save" onclick="saveMood()">Save</button>
                                        <button class="mood-btn cancel" onclick="cancelMoodEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="mood-edit-container" id="mood-edit-container">
                                <textarea class="mood-input" placeholder="How are you feeling today?" id="mood-input" maxlength="140"></textarea>
                                <div class="mood-actions">
                                    <span class="char-count" id="char-count">0/140</span>
                                    <div class="mood-buttons">
                                        <button class="mood-btn save" onclick="saveMood()">Save</button>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            
            {% elif widget.widget_type == 'calendar' %}
                <!-- Calendar Widget -->
                <div class="widget calendar-widget" id="calendar-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="calendar"></i>
                        AI Calendar
                    </div>
                    
                    <!-- Today's Info (Default View) -->
                    <div class="today-view" id="today-view">
                        <div class="today-date">
                            <div class="today-number" id="today-number">15</div>
                            <div class="today-info">
                                <div class="today-month" id="today-month">June</div>
                                <div class="today-year" id="today-year">2025</div>
                            </div>
                        </div>
                        
                        <div class="today-meetings">
                            <div class="meetings-header">Today's Meetings</div>
                            <div class="meetings-list" id="meetings-list">
                                <!-- Calendar events will be loaded dynamically -->
                                <div class="meeting-item" style="display: none;">
                                    <div class="meeting-time">Loading...</div>
                                    <div class="meeting-title">Loading meetings...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Quick Schedule -->
                        <div class="ai-quick-schedule mb-3">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="quick-schedule-input" 
                                       placeholder="Schedule meeting tomorrow..." style="background: rgba(255,255,255,0.9); border: 1px solid #e8e8e8; color: #1a1a1a;">
                                <button class="btn btn-outline-primary" type="button" id="quick-schedule-btn" style="border-color: #e8e8e8; background: rgba(255,255,255,0.9);">
                                    <i data-feather="plus" width="14" height="14"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button class="expand-calendar-btn" onclick="expandCalendar()" style="flex: 1;">
                                <i data-feather="maximize-2"></i>
                                View Full Calendar
                            </button>
                            <a href="/calendar" class="btn btn-outline-primary btn-sm" style="border-color: #e8e8e8; background: rgba(255,255,255,0.9); color: #1a1a1a; padding: 8px 12px; text-decoration: none; display: flex; align-items: center;">
                                <i data-feather="brain" width="14" height="14"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Full Calendar View (Hidden by default) -->
                    <div class="full-calendar-view" id="full-calendar-view" style="display: none;">
                        <div class="calendar-header">
                            <button class="btn-calendar-nav" onclick="previousMonth()">
                                <i data-feather="chevron-left"></i>
                            </button>
                            <div class="calendar-month-year" id="calendar-month-year">June 2025</div>
                            <button class="btn-calendar-nav" onclick="nextMonth()">
                                <i data-feather="chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="calendar-weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                        </div>
                        
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated by JavaScript -->
                        </div>
                        
                        <button class="collapse-calendar-btn" onclick="collapseCalendar()">
                            <i data-feather="minimize-2"></i>
                            Back to Today
                        </button>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'todo' %}
                <!-- Todo Widget -->
                <div class="widget todo-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="check-square"></i>
                        Todo
                    </div>
                    <div id="todo-list">
                        {% for todo in todos %}
                        <div class="todo-item" data-todo-id="{{ todo.id }}">
                            <div class="todo-checkbox" onclick="completeTodo({{ todo.id }})"></div>
                            <div class="todo-text">{{ todo.title }}</div>
                            <div class="todo-priority">{{ todo.priority }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="add-todo-btn" onclick="showAddTodoModal()">
                        <i data-feather="plus"></i>
                        Add Todo
                    </button>
                </div>
            
            {% elif widget.widget_type == 'focus_score' %}
                <!-- Focus Score Widget -->
                <div class="widget focus-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="target"></i>
                        Focus Score
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ focus_score }}%</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">85%</div>
                            <div class="stat-label">Average</div>
                        </div>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'water' %}
                <!-- Water Intake Widget -->
                <div class="widget water-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="droplet"></i>
                        Water Intake
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">{{ (total_water/1000)|round(1) }}L</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">8</div>
                            <div class="stat-label">Goal</div>
                        </div>
                    </div>
                </div>
            
            {% elif widget.widget_type == 'posture_score' %}
                <!-- Posture Score Widget -->
                <div class="widget posture-widget" data-position="{{ widget.position_y * 3 + widget.position_x }}">
                    <div class="widget-title">
                        <i data-feather="user"></i>
                        Posture
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">
                                {% if latest_posture %}
                                    {{ latest_posture.posture_quality|title }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <div class="stat-label">Current</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">
                                {% if latest_posture %}
                                    {{ latest_posture.angle|round(0) }}°
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <div class="stat-label">Angle</div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Modals and Global Components (outside of widget loop) -->
    <!-- Event Details Modal -->
    <div class="event-modal" id="event-modal" style="display: none;">
        <div class="event-modal-content">
            <div class="event-modal-header">
                <h3 id="event-title">Meeting Details</h3>
                <button class="close-modal" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="event-modal-body">
                <div class="event-field">
                    <label>Title:</label>
                    <input type="text" id="edit-event-title" class="event-input">
                </div>
                <div class="event-field">
                    <label>Time:</label>
                    <input type="time" id="edit-event-time" class="event-input">
                </div>
                <div class="event-field">
                    <label>Location:</label>
                    <input type="text" id="edit-event-location" class="event-input">
                </div>
                <div class="event-field">
                    <label>Description:</label>
                    <textarea id="edit-event-description" class="event-input" rows="3"></textarea>
                </div>
            </div>
            <div class="event-modal-actions">
                <button class="btn-save" onclick="saveEventChanges()">Save Changes</button>
                <button class="btn-delete" onclick="deleteEvent()">Delete Event</button>
                <button class="btn-cancel" onclick="closeEventModal()">Cancel</button>
            </div>
        </div>
    </div>



<!-- Customize Button -->
<button class="customize-btn" onclick="window.location.href='/moodboard/customize'">
    <i data-feather="settings"></i>
</button>

<!-- Add Todo Modal -->
<div class="modal fade" id="addTodoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Todo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="todoTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="todoTitle" placeholder="Enter todo title">
                </div>
                <div class="mb-3">
                    <label for="todoDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="todoDescription" rows="3" placeholder="Optional description"></textarea>
                </div>
                <div class="mb-3">
                    <label for="todoPriority" class="form-label">Priority</label>
                    <select class="form-select" id="todoPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="todoDueDate" class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="todoDueDate">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTodo()">Add Todo</button>
            </div>
        </div>
    </div>
</div>

<script>
// Update time and date
function updateDateTime() {
    const now = new Date();
    const timeEl = document.getElementById('moodboard-time');
    const dateEl = document.getElementById('moodboard-date');
    
    timeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    dateEl.textContent = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Calendar state
let currentCalendarDate = new Date();

// Update today's info and load calendar events
function updateTodayInfo() {
    const today = new Date();
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('today-number').textContent = today.getDate();
    document.getElementById('today-month').textContent = months[today.getMonth()];
    document.getElementById('today-year').textContent = today.getFullYear();
    
    // Load today's calendar events
    loadTodayCalendarEvents();
}

// Load today's calendar events from the API
function loadTodayCalendarEvents() {
    const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
    
    fetch(`/api/moodboard/calendar/events?date=${today}`)
        .then(response => response.json())
        .then(data => {
            const meetingsList = document.getElementById('meetings-list');
            
            if (data.success && data.events.length > 0) {
                meetingsList.innerHTML = '';
                
                data.events.forEach(event => {
                    const meetingItem = document.createElement('div');
                    meetingItem.className = 'meeting-item clickable';
                    meetingItem.setAttribute('data-event-id', event.id);
                    meetingItem.onclick = () => showEventDetails(event);
                    
                    const timeElement = document.createElement('div');
                    timeElement.className = 'meeting-time';
                    timeElement.textContent = event.time;
                    
                    const titleElement = document.createElement('div');
                    titleElement.className = 'meeting-title';
                    titleElement.textContent = event.title;
                    
                    if (event.location) {
                        const locationElement = document.createElement('div');
                        locationElement.className = 'meeting-location';
                        locationElement.textContent = event.location;
                        titleElement.appendChild(locationElement);
                    }
                    
                    meetingItem.appendChild(timeElement);
                    meetingItem.appendChild(titleElement);
                    meetingsList.appendChild(meetingItem);
                });
            } else {
                meetingsList.innerHTML = '<div class="meeting-item"><div class="meeting-time"></div><div class="meeting-title">No meetings scheduled</div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading calendar events:', error);
            const meetingsList = document.getElementById('meetings-list');
            meetingsList.innerHTML = '<div class="meeting-item"><div class="meeting-time"></div><div class="meeting-title">Error loading events</div></div>';
        });
}

// Generate calendar for full view
function generateCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const today = new Date();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    
    // Update month/year display
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('calendar-month-year').textContent = `${months[month]} ${year}`;
    
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = date.getDate();
        
        if (date.getMonth() !== month) {
            dayEl.classList.add('other-month');
        }
        
        if (date.toDateString() === today.toDateString()) {
            dayEl.classList.add('today');
        }
        
        calendarGrid.appendChild(dayEl);
    }
}

// Calendar navigation
function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    generateCalendar();
}

// Expand/collapse calendar
function expandCalendar() {
    const calendarWidget = document.getElementById('calendar-widget');
    calendarWidget.classList.add('expanded');
    document.getElementById('today-view').style.display = 'none';
    document.getElementById('full-calendar-view').style.display = 'block';
    generateCalendar();
    feather.replace();
}

function collapseCalendar() {
    const calendarWidget = document.getElementById('calendar-widget');
    calendarWidget.classList.remove('expanded');
    document.getElementById('today-view').style.display = 'block';
    document.getElementById('full-calendar-view').style.display = 'none';
    feather.replace();
}

// Event management functions
let currentEvent = null;

function showEventDetails(event) {
    currentEvent = event;
    
    // Populate modal with event details
    document.getElementById('event-title').textContent = event.title;
    document.getElementById('edit-event-title').value = event.title;
    document.getElementById('edit-event-time').value = event.time !== 'All Day' ? event.time : '';
    document.getElementById('edit-event-location').value = event.location || '';
    document.getElementById('edit-event-description').value = event.description || '';
    
    // Show modal
    document.getElementById('event-modal').style.display = 'flex';
}

function closeEventModal() {
    document.getElementById('event-modal').style.display = 'none';
    currentEvent = null;
}

function saveEventChanges() {
    if (!currentEvent) return;
    
    const updatedEvent = {
        id: currentEvent.id,
        title: document.getElementById('edit-event-title').value.trim(),
        time: document.getElementById('edit-event-time').value,
        location: document.getElementById('edit-event-location').value.trim(),
        description: document.getElementById('edit-event-description').value.trim()
    };
    
    if (!updatedEvent.title) {
        alert('Event title is required');
        return;
    }
    
    // Send update to server
    fetch(`/api/moodboard/calendar/events/${currentEvent.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updatedEvent)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEventModal();
            loadTodayCalendarEvents(); // Refresh calendar events
        } else {
            alert('Error updating event: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating event:', error);
        alert('Error updating event');
    });
}

function deleteEvent() {
    if (!currentEvent) return;
    
    if (!confirm(`Are you sure you want to delete "${currentEvent.title}"?`)) {
        return;
    }
    
    // Send delete request to server
    fetch(`/api/moodboard/calendar/events/${currentEvent.id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEventModal();
            loadTodayCalendarEvents(); // Refresh calendar events
        } else {
            alert('Error deleting event: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting event:', error);
        alert('Error deleting event');
    });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('event-modal');
    if (event.target === modal) {
        closeEventModal();
    }
});

// Update mood
function updateMood() {
    const moodInput = document.getElementById('mood-input');
    if (moodInput && moodInput.value.trim()) {
        fetch('/api/moodboard/mood', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mood_text: moodInput.value.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

// Load todos from API
function loadTodos() {
    const today = new Date().toISOString().split('T')[0];
    
    fetch(`/api/moodboard/todos?date=${today}`)
        .then(response => response.json())
        .then(data => {
            const todoList = document.querySelector('.todo-list');
            
            if (data.success && data.todos.length > 0) {
                todoList.innerHTML = '';
                
                data.todos.forEach(todo => {
                    const todoItem = document.createElement('div');
                    todoItem.className = `todo-item ${todo.is_completed ? 'completed' : ''}`;
                    todoItem.setAttribute('data-todo-id', todo.id);
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = todo.is_completed;
                    checkbox.onchange = () => completeTodo(todo.id);
                    
                    const content = document.createElement('div');
                    content.className = 'todo-content';
                    
                    const title = document.createElement('div');
                    title.className = 'todo-title';
                    title.textContent = todo.title;
                    
                    const meta = document.createElement('div');
                    meta.className = 'todo-meta';
                    
                    if (todo.due_time) {
                        meta.textContent = `Due: ${todo.due_time}`;
                        if (todo.has_calendar_event) {
                            meta.textContent += ' 📅';
                        }
                    } else if (todo.priority !== 'medium') {
                        meta.textContent = `Priority: ${todo.priority}`;
                    }
                    
                    content.appendChild(title);
                    if (meta.textContent) {
                        content.appendChild(meta);
                    }
                    
                    todoItem.appendChild(checkbox);
                    todoItem.appendChild(content);
                    todoList.appendChild(todoItem);
                });
            } else {
                todoList.innerHTML = '<div class="todo-item"><div class="todo-content"><div class="todo-title">No todos for today</div></div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading todos:', error);
            const todoList = document.querySelector('.todo-list');
            if (todoList) {
                todoList.innerHTML = '<div class="todo-item"><div class="todo-content"><div class="todo-title">Error loading todos</div></div></div>';
            }
        });
}

// Complete todo
function completeTodo(todoId) {
    fetch(`/api/moodboard/todo/${todoId}/complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const todoItem = document.querySelector(`[data-todo-id="${todoId}"]`);
            if (todoItem) {
                todoItem.style.opacity = '0.5';
                setTimeout(() => {
                    todoItem.remove();
                }, 300);
            }
        }
    });
}

// Show add todo modal
function showAddTodoModal() {
    const modal = new bootstrap.Modal(document.getElementById('addTodoModal'));
    modal.show();
}

// Add todo
function addTodo() {
    const title = document.getElementById('todoTitle').value.trim();
    const description = document.getElementById('todoDescription').value.trim();
    const priority = document.getElementById('todoPriority').value;
    const dueDate = document.getElementById('todoDueDate').value;
    
    if (!title) {
        alert('Please enter a title for the todo');
        return;
    }
    
    fetch('/api/moodboard/todo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            description: description,
            priority: priority,
            due_date: dueDate || null,
            create_calendar_event: false
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Mood editing functions
function editMood() {
    document.getElementById('mood-display').style.display = 'none';
    document.getElementById('mood-edit-container').style.display = 'block';
    
    const moodInput = document.getElementById('mood-input');
    moodInput.focus();
    
    // Set cursor to end of text
    moodInput.setSelectionRange(moodInput.value.length, moodInput.value.length);
    
    // Setup character counter
    updateCharCount();
}

function cancelMoodEdit() {
    document.getElementById('mood-display').style.display = 'block';
    document.getElementById('mood-edit-container').style.display = 'none';
}

function saveMood() {
    const moodInput = document.getElementById('mood-input');
    const moodText = moodInput.value.trim();
    
    if (!moodText) {
        alert('Please enter your mood');
        return;
    }
    
    if (moodText.length > 140) {
        alert('Mood text must be 140 characters or less');
        return;
    }
    
    fetch('/api/moodboard/mood', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mood_text: moodText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the display text
            const moodDisplay = document.getElementById('mood-display');
            if (moodDisplay) {
                moodDisplay.textContent = moodText;
                cancelMoodEdit();
            } else {
                // If no display element exists (first time), reload to show the new structure
                location.reload();
            }
        } else {
            alert('Failed to save mood: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving mood:', error);
        alert('Failed to save mood. Please try again.');
    });
}

function updateCharCount() {
    const moodInput = document.getElementById('mood-input');
    const charCount = document.getElementById('char-count');
    
    if (moodInput && charCount) {
        const currentLength = moodInput.value.length;
        charCount.textContent = `${currentLength}/140`;
        
        // Change color if approaching limit
        if (currentLength > 120) {
            charCount.style.color = '#ffcccb';
        } else {
            charCount.style.color = 'var(--flow-warm-600)';
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateDateTime();
    setInterval(updateDateTime, 60000); // Update every minute
    updateTodayInfo(); // This also loads calendar events
    
    // Add AI calendar quick schedule functionality
    setupAIQuickSchedule();
    loadTodos(); // Load today's todos
    
    // Setup mood input character counter
    const moodInput = document.getElementById('mood-input');
    if (moodInput) {
        moodInput.addEventListener('input', updateCharCount);
        moodInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveMood();
            }
        });
        updateCharCount(); // Initialize counter
    }
    
    // Initialize Feather icons
    feather.replace();
});

// AI Calendar Quick Schedule Setup
function setupAIQuickSchedule() {
    const quickScheduleInput = document.getElementById('quick-schedule-input');
    const quickScheduleBtn = document.getElementById('quick-schedule-btn');
    
    if (!quickScheduleInput || !quickScheduleBtn) return;
    
    // Handle button click
    quickScheduleBtn.addEventListener('click', () => {
        processQuickSchedule();
    });
    
    // Handle enter key
    quickScheduleInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            processQuickSchedule();
        }
    });
}

// Process AI quick schedule request
async function processQuickSchedule() {
    const input = document.getElementById('quick-schedule-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    try {
        // Show loading state
        const btn = document.getElementById('quick-schedule-btn');
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<span style="font-size: 12px;">...</span>';
        btn.disabled = true;
        
        // Send to AI calendar chat endpoint
        const response = await fetch('/api/calendar/ai-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear input
            input.value = '';
            
            // Show success feedback
            showQuickScheduleFeedback(data.response, 'success');
            
            // Refresh calendar events if event was created
            if (data.event_created) {
                loadTodayCalendarEvents();
            }
        } else {
            showQuickScheduleFeedback(data.error || 'Failed to process request', 'error');
        }
        
        // Restore button
        btn.innerHTML = originalIcon;
        btn.disabled = false;
        
    } catch (error) {
        console.error('Error processing quick schedule:', error);
        showQuickScheduleFeedback('Error processing request', 'error');
        
        // Restore button
        const btn = document.getElementById('quick-schedule-btn');
        btn.innerHTML = '<i data-feather="plus" width="14" height="14"></i>';
        btn.disabled = false;
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    }
}

// Show feedback for quick schedule
function showQuickScheduleFeedback(message, type) {
    // Create or update feedback element
    let feedback = document.getElementById('quick-schedule-feedback');
    if (!feedback) {
        feedback = document.createElement('div');
        feedback.id = 'quick-schedule-feedback';
        feedback.style.cssText = `
            font-size: 0.75rem;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s;
        `;
        document.querySelector('.ai-quick-schedule').appendChild(feedback);
    }
    
    // Style based on type
    if (type === 'success') {
        feedback.style.background = 'rgba(46, 204, 113, 0.1)';
        feedback.style.color = '#27ae60';
        feedback.style.border = '1px solid rgba(46, 204, 113, 0.2)';
    } else {
        feedback.style.background = 'rgba(231, 76, 60, 0.1)';
        feedback.style.color = '#e74c3c';
        feedback.style.border = '1px solid rgba(231, 76, 60, 0.2)';
    }
    
    feedback.textContent = message;
    feedback.style.opacity = '1';
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        if (feedback) {
            feedback.style.opacity = '0';
            setTimeout(() => {
                if (feedback && feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 300);
        }
    }, 3000);
}

</script>
{% endblock %}